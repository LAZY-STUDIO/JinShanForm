# 易佳怡

## 每日进度

6月6日

> 易佳怡：
>
> - 完成登录注册页面的UI设计
>
> - 完成表单验证
>
>   ![okay1](.\mdImgs\okay1.png)

6月7日

> 易佳怡：
>
> - 新增IUser和IForm类型，定义**UserRes**接口和**FormListRes**接口
>
>   ![okay2](.\mdImgs\okay2.png)
>
> - 封装用户注册登录、处理登录逻辑
>
>   ```js
>     async loginSub() {
>         const res = await login(this.formData.account, this.formData.pwd)
>         if (res.stat != 'ok') {
>           ElMessage({
>             message: res.msg,
>             duration: 2000,
>             type: 'error',
>             customClass: 'msg-box-form-title',
>           })
>         } else {
>           const user = await this.getUser()
>           if (user.avatar === '') {
>             user.avatar =
>               '默认图片路径'
>           }
>           store.commit('setUser', user)
>           sessionStorage.setItem('token', 'Bearer xxxx')
>           sessionStorage.setItem('user', JSON.stringify(user))
>           this.$router.push({
>             name: 'HomeView',
>           })
>         }
>       },
>   ```
>
> - 期末考试复习

6月7日

> 易佳怡：
>
> - 期末考试复习

6月8日

> 易佳怡：
>
> - 期末考试复习

6月9日

> 易佳怡：
>
> - 完成导航守卫
>
>   ```js
>   router.beforeEach(function (to, from, next) {
>     if (to.path === '/login' || to.path === '/register') {
>       next()
>     } else {
>       const token = sessionStorage.getItem('token')
>       if (token) {
>         next()
>       } else {
>         ElMessage({
>           message: '请先登录',
>           duration: 2000,
>           type: 'error',
>           customClass: 'msg-box-form-title',
>         })
>         next('/login')
>       }
>     }
>   })
>   ```
>
> - 完成首页UI结构设计并渲染formList列表
>
>   

6月10日

> 易佳怡：
>
> - 封装FormList组件
>
> - 完成表单标星，删除，开始发布，停止等，实现仅展示星标。
>
>   ![okay3](.\mdImgs\okay3.png)
>
>   ![okay4](.\mdImgs\okay4.png)

6月11日

> 易佳怡：
>
> - 期末考试复习

6月12日

> 易佳怡：
>
> - 期末考试复习

6月13日

> 易佳怡：
>
> - 分离MyHeader
>
> - 处理草稿问题以及分页的功能
>
>   
>
>   ![okay5](F:\前端\金山\teamwork3.0\leibuyun\mdImgs\okay5.png)

6月14日

> 易佳怡：
>
> - 自定义回收站内容
>
>   ![okay6](F:\前端\金山\teamwork3.0\leibuyun\mdImgs\okay6.png)

6月15日

> 易佳怡：
>
> - 配置操作中的全部路由，美化css样式

## 问题与解决方法

- 注册组件中密码相等验证失效

  > ​	解决方法：**element plu官网提供的自定义验证函数是放在data中**，然后在rules中进行引用
  >
  > 由于ts的影响导致类型出错，**将验证函数放在methods后**，验证生效
  >
  > ```js
  >  methods: {
  >     validatePass2(rule: string, value: string, callback: any) {
  >       if (value === '') {
  >         callback(new Error('请再次输入密码'))
  >       } else if (value !== this.formData.pwd) {
  >         callback(new Error('两次输入密码不一致!'))
  >       } else {
  >         callback()
  >       }
  >     },
  >   },
  > ```
  >
  > 

- 取消滚动条

  > ​	解决方法：将头部结构放入main中
  >

- 登录后如何保存用户状态的问题

  > 问题说明：首先考虑的是用vuex保存用户信息，后期发现**Vuex刷新后数据会消失**
  >
  > ​                    随后考虑用localstorage保存，但是这样的话，用户信息一直存在浏览器且不安全
  >
  > ​					最后决定用session进行存储，这样用户信息可以随着窗口的关闭而消失	
  >
  > 解决方法：**利用session存储用户信息**
  >
  > 原代码：
  >
  > ```javascript
  > import { createStore } from 'vuex'
  > import { IUser } from '../types'
  > 
  > export default createStore({
  >   state: {
  >     user: {} as IUser,
  >     show: 0,
  >   },
  >   getters: {
  >     user: (state) => state.user,
  >     // show: (state) => state.show,
  >   },
  >   mutations: {
  >     setUser(state, user) {
  >       state.user = user
  >     },
  >     // showAction(state, params) {
  >     //   state.show = params
  >     // },
  >   },
  >   actions: {},
  >   modules: {},
  > })
  > ```
  >
  > 修改后
  >
  > ```javascript
  >  sessionStorage.setItem('user', JSON.stringify(user))
  > ```
  >

- 限制用户未登录直接进入首页的情况

  > 解决方法：**设置导航守卫**
  >
  > ```javascript
  > //用户登录后，在session中自定义一个token
  >   sessionStorage.setItem('token', 'Bearer xxxx')
  > 
  > 
  > //通过是否有session值判断用户是否登录
  > const token = sessionStorage.getItem('token')
  >     if (token) {
  >       next()
  >     }
  > ```
  >

- 完成仅展示标星功能

  > 解决方法：对formList数组进行遍历，对样式进行动态绑定
  >
  > ```javascript
  > onlyShow() {
  >       if (!this.showOnlyStar) {
  >         this.showOnlyStar = true
  >         for (let i = 0; i < this.formList.length; i++) {
  >           if (!this.formList[i].isStar) {
  >             this.formList.splice(i, 1)
  >             i--
  >           }
  >         }
  >       } else {
  >         this.showOnlyStar = false
  >         this.fun()
  >       }
  >     },
  > ```
  >
  > ```html
  > <div :class="showOnlyStar ? 'star onlyStar' : 'star'" @click="onlyShow">
  >         <span :class="showOnlyStar ? 'fullStar' : ''">
  >           <i class="iconfont icon-star-empty" v-show="!showOnlyStar"></i>
  >           <i class="iconfont icon-star-full" v-show="showOnlyStar"></i>
  >         </span>
  >         仅展示星标
  > </div>
  > ```
  >
  > 

- 表单分页功能

  > 解决方法：**利用el-pagination**,新增currentForm数组，用来存储当前页面的数据，动态的赋值给formList
  >
  > ```html
  > <div class="block">
  >         <el-pagination
  >           align="right"
  >           @current-change="handleCurrentChange"
  >           :current-page="currentPage"
  >           :page-size="pageSize"
  >           :total="formList.length"
  >           layout="prev, pager, next,total"
  >           background
  >           v-show="formList.length !== 0"
  >         />
  >       </div>
  > ```
  >
  > ```js
  >   this.currentForm = this.formList.slice(
  >         (this.currentPage - 1) * this.pageSize,
  >         this.currentPage * this.pageSize
  >       )
  > ```
  >
  > 

- 头部右边插槽不一致的问题

  > 解决方法：设置默认内容，右边没有元素的情况，则用空的div代替
  >
  > ```html
  > <slot name="right">
  >         <div
  >           class="user"
  >           tabindex="0"
  >           @click="howshow = !howshow"
  >           @blur="howshow = false"
  >         >
  >           <div class="user-img">
  >             <img :src="user.avatar" width="30px" />
  >           </div>
  >           <p class="user-title">{{ user.account }}</p>
  >           <div class="logout" v-show="howshow">
  >             <div>{{ user.account }}</div>
  >             <div @click="goPersonal" @click.stop>个人中心</div>
  >             <div @click="goout">退出登录</div>
  >           </div>
  >         </div>
  >       </slot>
  > ```
  >
  > 
  
- 处理草稿问题

  > 解决方法：通过用户名+drafs从localStrorage读取草稿数据，并在初始化时将其与端口数据合并
  >
  > ```js
  > let dLstStr = localStorage.getItem(account + 'DraftList')
  >       let draftList = [] as IForm[]
  >       if (dLstStr) {
  >         draftList = JSON.parse(dLstStr)
  >       }
  >       this.drafts = draftList
  >       const { data } = await getFormList(account)
  >       this.formList = [...draftList, ...data.items]
  > ```
  >
  > 

- 解决回收站和列表切换问题

  > 解决方法：设置两个数组，分别用来存储两份数据，在删除的时候记得过滤
  >
  > ```js
  >  async formDelete(id: string) {
  >       if (this.noDeleteForm) this.noDeleteForm = []
  >       for (let i = 0; i < this.formList.length; i++) {
  >         if (this.formList[i].id === id) {
  >           //判断是否为草稿
  >           if (this.formList[i].status === 1) {
  >             this.formList[i].status = 15
  >           } else {
  >             this.formList[i].status = 5
  >           }
  >           this.deleteForm.push(this.formList[i])
  >         } else {
  >           this.noDeleteForm.push(this.formList[i])
  >         }
  >       }
  >       this.formList = this.noDeleteForm
  >       this.currentForm = this.noDeleteForm.slice(
  >         (this.currentPage - 1) * this.pageSize,
  >         this.currentPage * this.pageSize
  >       )
  >       localStorage.setItem(
  >         this.user.account + 'Delete',
  >         JSON.stringify(this.deleteForm)
  >       )
  >     },
  > ```
  >
  > 

- 解决恢复表单后找不到原始状态问题

  > 解决方法：在localStrorage存储一个由id和old（旧的状态）存储的对象数组
  >
  > ```js
  >  //存oldId
  >           const oldStr = localStorage.getItem(this.user.account + 'oldId')
  >           let oldList = [] as { id: string; old: number }[]
  >           if (oldStr) {
  >             oldList = JSON.parse(oldStr)
  >           }
  >           let idx = -1
  >           for (let i = 0; i < oldList.length; i++) {
  >             if (oldList[i].id === id) {
  >               idx = i
  >               break
  >             }
  >           }
  >           if (idx === -1) {
  >             oldList.push({
  >               id: id,
  >               old: this.formList[i].status,
  >             })
  >           } else {
  >             oldList[idx].old = this.formList[i].status
  >           }
  >           localStorage.setItem(
  >             this.user.account + 'oldId',
  >             JSON.stringify(oldList)
  >           )
  > 
  > //恢复
  > const oldStr = localStorage.getItem(this.user.account + 'oldId')
  >           let oldList = [] as { id: string; old: number }[]
  >           if (oldStr) {
  >             oldList = JSON.parse(oldStr)
  >           }
  >           for (let j = 0; j < oldList.length; j++) {
  >             if (oldList[j].id === id) {
  >               this.deleteForm[i].status = oldList[j].old
  >               break
  >             }
  >           }
  > ```
  >
  > 

- 刷新后回收站消失问题

  > 解决方法：在删除时将删除的数据保存在localStrorage中，初始化时过滤一下
  >
  > ```js
  > localStorage.setItem(
  >         this.user.account + 'Delete',
  >         JSON.stringify(this.deleteForm)
  >       )
  > ```
  >
  > ```js
  >  let DeleteStr = localStorage.getItem(this.user.account + 'Delete')
  >       if (DeleteStr) {
  >         this.deleteForm = JSON.parse(DeleteStr)
  >         this.formList = this.formList.filter(
  >           (form) =>
  >             this.deleteForm.filter((iform) => iform.id === form.id).length === 0
  >         )
  >       }
  > ```

  

## 个人总结与收获

>易佳怡：本次项目主要负责注册，登录，首页和头部组件部分，对element plus的使用更加的熟练，例如表单验证，对session，localstrorage，token，cookie等了解更加透彻，对接口的使用和继承也有了部分了解，之前总是困惑接口的意义，总觉得是在徒增编码难度，但是发现在大型开发项目中，接口的复用性提高，也更加贴合后端的工作，维护起来也更加方便。导航守卫的使用使得整个项目更加安全，当然关于用户信息的安全问题还需要进行更多的处理。使用git进行团队开发，让我受益匪浅，对以后的工作也会有更多的帮助。当然还是有一些不足，对数据的处理有些冗余，对数组的一些方法filter,map等使用还不够熟练，有待加强。总之，经过这次的项目，收获满满，看着项目一点点搭建起来的过程非常的快乐且有成就感！对未来的编程之旅充满了信心！
>
>